# Description:	LLVM toolchain - llvm,clang,compiler-rt
# URL:		http://llvm.org/
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com
# Depends on:	git libedit libxml2 python3-setuptools samurai

name=llvm-toolchain
_realname=llvm-project
version=18.1.7
release=1
source=(https://github.com/llvm/${_realname}/releases/download/llvmorg-${version}/${_realname}-${version}.src.tar.xz)

build() {
	cd ${_realname}-${version}.src

	# add musl triples
	sed 's|"x86_64-amazon-linux"};|"x86_64-amazon-linux", "x86_64-unknown-linux-musl"};|' \
		-i clang/lib/Driver/ToolChains/Gnu.cpp

	export CC="gcc"
	export CXX="g++"

	# saux uses -flto=auto -ffat-lto-objects - turn it off
	export CFLAGS="${CFLAGS/ -flto=auto -ffat-lto-objects/}"
	export CXXFLAGS="${CXXFLAGS/ -flto=auto -ffat-lto-objects/}"

	mkdir build
	cd build

	cmake -G Ninja \
		-DLLVM_HOST_TRIPLE="$CHOST" \
		-DCMAKE_BUILD_TYPE="Release" \
		-DCMAKE_INSTALL_PREFIX="/usr" \
		-DCMAKE_INSTALL_LIBEXECDIR="/usr/lib/clang" \
		-DLLVM_ENABLE_PROJECTS="clang;compiler-rt" \
		-DLLVM_BINUTILS_INCDIR=/usr/include \
		-DCOMPILER_RT_BUILD_SANITIZERS=OFF \
		-DCOMPILER_RT_INSTALL_PATH="/usr/lib/clang/${version:0:2}" \
		-DLLVM_OPTIMIZED_TABLEGEN=ON \
		-DLLVM_BUILD_LLVM_DYLIB=ON \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		-DLLVM_BUILD_TOOLS=ON \
		-DLLVM_INCLUDE_UTILS=ON \
		-DLLVM_INSTALL_UTILS=ON \
		-DLLVM_ENABLE_TERMINFO=ON \
		-DLLVM_ENABLE_ZLIB=ON \
		-DLLVM_ENABLE_ZSTD=ON \
		-DLLVM_ENABLE_FFI=ON \
		-DLLVM_ENABLE_PIC=ON \
		-DLLVM_ENABLE_RTTI=ON \
		-DCLANG_LINK_CLANG_DYLIB=ON \
		-DLIBCLANG_BUILD_STATIC=ON \
		-DENABLE_LINKER_BUILD_ID=ON \
		-DCLANG_PLUGIN_SUPPORT=ON \
		-DLLVM_ENABLE_LIBCXX=OFF \
		-DLLVM_INCLUDE_TESTS=OFF \
		-DLLVM_ENABLE_SPHINX=OFF \
		-DLLVM_ENABLE_OCAMLDOC=OFF \
		-DLLVM_INCLUDE_EXAMPLES=OFF \
		-DLLVM_INCLUDE_BENCHMARKS=OFF \
		-DLLVM_APPEND_VC_REV=OFF \
		-DCLANG_VENDOR="(SAUX-x86_64 musl)" \
		-Wno-dev \
		../llvm

	ninja

	DESTDIR=$PKG ninja install

	install -d $PKG/usr/lib/bfd-plugins
	ln -s ../libLTO.so $PKG/usr/lib/bfd-plugins/

	/usr/bin/python3 \
		../llvm/utils/lit/setup.py build
	/usr/bin/python3 \
		../llvm/utils/lit/setup.py install --root=$PKG
}
